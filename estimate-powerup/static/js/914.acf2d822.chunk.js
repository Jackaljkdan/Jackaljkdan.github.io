"use strict";(self.webpackChunkestimate_powerup=self.webpackChunkestimate_powerup||[]).push([[914],{732:(e,t,n)=>{n.d(t,{b:()=>f});n(2791);var a=n(6258),o=n(4303),i=n(4305),r=n(1166),s=n(5728);function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return e.length<t?e:e.substring(0,t-3)+"..."}var c=n(146),u=n(6683),d=n(9697),v=n(8282),m=n(184);function f(e){var t,n,f,p;const h=(0,c.D)(),w=(0,a.k)(),y=(0,r.DP)(null===(t=w.value)||void 0===t?void 0:t.startDate),k=(0,o.th)("id"),g=(0,o.lg)(h,null===(n=w.value)||void 0===n?void 0:n.cardId,"id","name"),M=(0,u.Kb)(h,"id"),b=void 0!==(null===(f=w.value)||void 0===f?void 0:f.cardId)&&!w.isSaving;return k||b?(0,m.jsxs)("div",{className:"work-button-wrapper",children:[(0,m.jsxs)("button",{className:"work-button ".concat(b?"mod-danger":"mod-primary"),onClick:async t=>{if(void 0!==M)if(b||void 0===k){if(b){var n,a;const o=Math.round((0,d.qG)(w.value.startDate))/60;w.set(null);const r=await(0,i.oc)(h,w.value.cardId);await(0,i.Eo)(h,{...r,workMinutes:{...r.workMinutes,[M.id]:(null!==(n=r.workMinutes[M.id])&&void 0!==n?n:0)+o}},w.value.cardId),await(0,v.mY)(h,{action:async e=>(0===e.workMinutes&&(e.startDate=(0,d.HH)(e.startDate,-o)),e.workMinutes+=o,e),hoursPerDay:s.xZ,mouseEvent:t}),null===(a=e.onEstimateChanged)||void 0===a||a.call(e)}}else w.set({cardId:k.id,startDate:new Date}),(0,v.D3)(h,{hoursPerDay:s.xZ,mouseEvent:t})},children:[w.isSaving?"...":null,w.isSaving?null:[b?"End work":"Start work",b?" "+(0,s.yz)(y,{zero:""}):null,b&&(null===k||void 0===k?void 0:k.id)!==(null===(p=w.value)||void 0===p?void 0:p.cardId)?" (on".concat(k?" other":""," card").concat(void 0===g?"":': "'.concat(l(g.name,8),'"'),")"):null]]}),b?(0,m.jsx)("button",{className:"cancel-work-button",onClick:e=>h.popup({type:"confirm",title:"Cancel work?",message:"Are you sure you want to cancel the work in progress?",confirmText:"Yes",onConfirm:e=>(w.set(null),e.closePopup()),cancelText:"No",onCancel:e=>e.closePopup(),mouseEvent:e.nativeEvent}),children:"X"}):null]}):null}},4303:(e,t,n)=>{n.d(t,{Fo:()=>l,lg:()=>v,nb:()=>u,th:()=>d});var a=n(2791),o=n(1933),i=n(5678),r=n(146),s=n(9416);function l(e){const t="card",n=(0,o.useQueryClient)(),i=(0,o.useQuery)(t,(async()=>(await e.card("dueComplete")).dueComplete),{staleTime:1e3}),r=(0,a.useCallback)((e=>n.setQueryData(t,e)),[n]);return(0,a.useMemo)((()=>({...i,setData:r})),[i,r])}function c(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];const[r,l]=(0,a.useState)(),c=(0,a.useCallback)((async()=>{let t;try{t=await e.card(...n)}catch(a){return void console.warn("no card in context")}l(t)}),i.w);return(0,s.cM)(e,c),(0,a.useMemo)((()=>({card:r,refresh:c,setCard:l})),[r])}function u(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];const{card:o}=c(e,...n);return o}function d(){const e=(0,r.D)();for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return u(e,...n)}function v(e,t){for(var n=arguments.length,o=new Array(n>2?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];const[r,s]=(0,a.useState)();return(0,a.useEffect)((()=>{async function n(){if(void 0===t)return;const n=await e.cards(...o);for(const e of n)if(e.id===t){s(e);break}}n(),e.render(n)}),[t]),r}},6258:(e,t,n)=>{n.d(t,{k:()=>v});var a=n(2791),o=n(1933),i=n(4305),r=n(8286),s=n(1640),l=n(5728),c=n(146),u=n(9416);const d="current_work";function v(){const e=(0,c.D)(),t=(0,o.useQueryClient)(),n=function(e){const t=(0,o.useQuery)(d,(()=>(0,i.X8)(e)),{staleTime:(0,l.y2)(2),cacheTime:1/0,refetchOnMount:!1,refetchOnReconnect:!1,refetchOnWindowFocus:!1});return(0,u.he)(e,{refresh:t.refetch,callImmediately:!1}),(0,s.D)((()=>{const e=r.W.on(t.refetch);return()=>r.W.off(e)})),t}(e),[v,m]=(0,a.useState)(!1),f=(0,a.useCallback)((async n=>{m(!0),await(0,i.w9)(e,n),t.setQueryData(d,n),m(!1)}),[e,t]);return(0,a.useMemo)((()=>({value:n.data,isSaving:v,set:f})),[n.data,v,f])}},1166:(e,t,n)=>{n.d(t,{DP:()=>i});var a=n(2791),o=n(9697);function i(e){return r(e)/1e3/60}function r(e){const[t,n]=(0,a.useState)(0);return(0,a.useEffect)((()=>{if(void 0===e)return void n(0);let t,a=!1;return t=requestAnimationFrame((function i(){n((0,o.ne)(e)),a||(t=requestAnimationFrame(i))})),()=>{a=!0,cancelAnimationFrame(t)}}),[e]),t}},6683:(e,t,n)=>{n.d(t,{Kb:()=>i,Zt:()=>l,xr:()=>r});var a=n(2791),o=n(146);function i(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];const i=(0,a.useState)(),[r,s]=i;return(0,a.useEffect)((()=>{const t=void 0!==n&&n.length>0?n:["id"];e.member(...t).then((e=>s(e)))}),[e]),r}function r(){const e=(0,o.D)();for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return i(e,...n)}function s(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const[n,o]=(0,a.useState)();return(0,a.useEffect)((()=>{t||void 0!==n||e.board("members").then((e=>{const t={};for(const n of e.members)t[n.id]=n;o(t)}))}),[e,t,n]),n}function l(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=(0,o.D)();for(var n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++)a[i-1]=arguments[i];return s(t,e,...a)}},146:(e,t,n)=>{let a;function o(){return void 0===a&&(a=window.TrelloPowerUp.iframe({appName:"Estimate",appKey:"dadac0f685db6faecaa69b90f19ba321"})),a}n.d(t,{D:()=>o})},9416:(e,t,n)=>{n.d(t,{cM:()=>i,he:()=>o});var a=n(1640);function o(e,t){(0,a.D)((()=>{t.callImmediately&&t.refresh(),e.render(t.refresh)}))}function i(e,t){return o(e,{refresh:t,callImmediately:!0})}},1640:(e,t,n)=>{n.d(t,{D:()=>i});var a=n(2791),o=n(5678);function i(e){return(0,a.useEffect)(e,o.w)}},5678:(e,t,n)=>{n.d(t,{w:()=>a});const a=[]},914:(e,t,n)=>{n.r(t),n.d(t,{default:()=>P});var a=n(2791),o=n(5728),i=n(6683),r=n(4305),s=n(5678);var l=n(732),c=n(4303),u=n(146);const d="https://api.trello.com/1",v="dadac0f685db6faecaa69b90f19ba321";function m(e,t,n){const a={...n,key:v,token:e},o=Array.from(function*(e){for(const t in e)yield t}(a),(e=>e+"="+a[e])).join("&");return i={url:d+"/cards/".concat(t,"?").concat(o),method:"PUT"},fetch(i.url,{...i,headers:{Accept:"application/json",...null===i||void 0===i?void 0:i.headers}}).then((e=>e.json().then((t=>{const n=e;return n.data=t,n.request=i,n}))));var i}var f=n(184);function p(e){const t=(0,u.D)(),n=(0,c.nb)(t,"id","due"),a=(0,c.Fo)(t);return(0,f.jsxs)("button",{className:"complete-work ".concat(e.className),onClick:()=>{void 0!==n&&function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"read,write";return e.getRestApi().isAuthorized().then((e=>{if(!e)throw new Error("unauthorized")})).catch((()=>e.getRestApi().authorize({scope:t}))).then((()=>e.getRestApi().getToken()))}(t).then((e=>m(e,n.id,{due:a.data?null:n.due?n.due:(new Date).toISOString(),dueComplete:!a.data}))).then((e=>{e.ok&&a.setData(e.data.dueComplete)})).catch((e=>{console.error(e)}))},children:[void 0===a.data?"loading...":null,void 0!==a.data?[a.data?"Uncomplete card":null,a.data?null:"Complete card"]:null]})}var h=n(6258);function w(e){var t;const n=(0,u.D)(),a=(0,h.k)(),o=(0,c.nb)(n,"id");return void 0===(null===(t=a.value)||void 0===t?void 0:t.cardId)||void 0===o||a.value.cardId===o.id?null:(0,f.jsx)("button",{className:"open-work ".concat(e.className),onClick:()=>n.showCard(a.value.cardId),children:"Open work card"})}var y=n(9416);function k(e){var t,n,a,o;return(0,f.jsxs)("div",{className:"time-buttons ".concat(null!==(t=e.className)&&void 0!==t?t:""),children:[(0,f.jsx)("div",{className:"label",children:e.label}),(0,f.jsx)("button",{onClick:t=>e.action(t,((e,t)=>t)),children:null!==(n=e.setLabel)&&void 0!==n?n:"Set"}),(0,f.jsx)("button",{onClick:t=>e.action(t,((e,t)=>e+t)),children:"+"}),(0,f.jsx)("button",{onClick:t=>e.action(t,((e,t)=>e-t)),children:"-"}),null===(a=e.showClear)||void 0===a||a?(0,f.jsx)("button",{onClick:e.clearAction,children:null!==(o=e.clearLabel)&&void 0!==o?o:"Clear"}):null]})}var g=n(9697);const M={isApplicable:async e=>Boolean(await(0,r.bS)(e)),getTitle:async e=>{const t=await(0,r.bS)(e),n=(0,g.Zd)(t);return"Add time since last input as work (".concat((0,o.JB)(n),")")},call:async e=>{const t=await(0,r.bS)(e),n=await e.card("id");await(0,r.s9)(e,(0,g.Zd)(t),n.id)}};var b=n(2168),D=n(9005);const E={isApplicable:async e=>{const t=(0,b.b)();if(!t)return!1;const n=await(0,r.X8)(e);return!(null===n||void 0===n||!n.startDate)&&t>n.startDate},getTitle:async e=>{const t=await(0,r.X8)(e),n=(0,b.b)(),a=(0,g.oE)(t.startDate,n);return"I forgot to end work before closing (close time: ".concat((0,D.p)(n,"yyyy-MM-dd hh:mm:ss")," work: ").concat((0,o.JB)(a),")")},call:async e=>{const t=await(0,r.X8)(e),n=(0,b.b)(),a=(0,g.oE)(t.startDate,n);await(0,r.s9)(e,a,t.cardId),await(0,r.w9)(e,null)}};function x(e){var t;const n=(0,u.D)();async function a(t,a){await a.isApplicable(n)&&t.push({text:await a.getTitle(n),callback:async t=>{var o;await a.call(n),null===(o=e.onRefresh)||void 0===o||o.call(e),await t.closePopup()}})}return(0,f.jsx)("button",{className:"".concat(null!==(t=e.className)&&void 0!==t?t:""),onClick:async e=>{const t=[];await a(t,M),await a(t,E),n.popup({title:"More functions",items:t,mouseEvent:e.nativeEvent})},children:"\u22ef"})}var C=n(8282),S=n(1166),j=n(3265);function A(e){var t,n,i,s;const{estimate:l,member:d}=e,[v,m]=(0,a.useState)(!1),[p,w]=(0,a.useState)(),y=(0,u.D)(),k=(0,c.nb)(y,"id"),g=null!==(t=(0,c.Fo)(y).data)&&void 0!==t&&t,M=(0,h.k)(),b=(0,S.DP)((null===(n=M.value)||void 0===n?void 0:n.cardId)===(null===k||void 0===k?void 0:k.id)?null===(i=M.value)||void 0===i?void 0:i.startDate:void 0);(0,a.useEffect)((()=>{v&&void 0===p&&y.board("members").then((e=>{const t={};for(const n of e.members)t[n.id]=n;w(t)}))}),[v,p]);const D=(0,r.y7)(l)+b,E=null!==(s=b+l.workMinutes[d.id])&&void 0!==s?s:0,x=(0,r.V9)(l,g,D);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsxs)("div",{className:"card-label",children:["Work: ",(0,o.JB)(D)," ",E<D?["(mine: ",(0,o.JB)(E),")"]:null," ",E<D?(0,f.jsx)("span",{className:"work-details link-like",onClick:()=>m((e=>!e)),children:"details"}):null,g?null:[" | "," Remaining: ",(0,o.JB)(x)],g?[" | ",(0,j.W)({delta:(0,j.M)({cardId:null===k||void 0===k?void 0:k.id,estimate:l,totalWorkMinutes:D})})]:null]}),v&&void 0!==p?(0,f.jsx)("div",{children:[...(0,r.Wm)(l)].filter((e=>e.minutes>0)).map((e=>{var t;const n=p[e.memberId];return(0,f.jsxs)("div",{children:[null!==(t=null===n||void 0===n?void 0:n.fullName)&&void 0!==t?t:"<missing>",n&&" ",void 0!==n?"(".concat(n.username,")"):"",": ",(0,o.JB)(e.minutes)]},e.memberId)}))}):null]})}function N(e){var t;const{estimate:n,member:a}=e,i=(0,u.D)();if(void 0===n.value)return(0,f.jsx)("div",{children:n.feedback});const s=(0,r.y7)(n.value),l=null!==(t=n.value.workMinutes[a.id])&&void 0!==t?t:0;async function c(e){const t=await e.action();if(!t)return;const n=t.workMinutes[a.id];void 0!==n&&i.popup({type:"confirm",title:"Add to session?",message:"Should this work change count in your work session?",confirmText:"Yes",onConfirm:t=>(t.closePopup(),(0,C.mY)(i,{action:async e=>({...e,workMinutes:e.workMinutes+n}),hoursPerDay:o.xZ,mouseEvent:e.mouseEvent})),cancelText:"No",onCancel:e=>e.closePopup(),mouseEvent:e.mouseEvent.nativeEvent})}return(0,f.jsx)(k,{label:(0,f.jsx)(A,{estimate:n.value,member:a}),action:(t,r)=>c({action:()=>(0,o.MG)(i,e.inputState,(e=>n.set((t=>{var n;return{...t,workMinutes:{...t.workMinutes,[a.id]:r(null!==(n=t.workMinutes[a.id])&&void 0!==n?n:0,e)}}})))),mouseEvent:t}),showClear:s>0,clearAction:e=>{i.popup({type:"confirm",title:"Clear?",message:"Are you sure you want to clear the work (".concat((0,o.JB)(s),")?"),confirmText:"Yes",onConfirm:async t=>{await c({action:()=>n.set((e=>({...e,workMinutes:{...e.workMinutes,[a.id]:0}}))),mouseEvent:e}),await t.closePopup()},cancelText:"No",onCancel:e=>e.closePopup(),mouseEvent:e.nativeEvent})},clearLabel:l<s?"Clear mine":void 0,setLabel:l<s?"Set mine":void 0,className:e.className})}function P(){const e=(0,u.D)(),t=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const[n,o]=(0,a.useState)(),[i,l]=(0,a.useState)(""),c=(0,a.useMemo)((()=>async()=>{l("loading...");const t=await(0,r.oc)(e);o(t),l("")}),s.w),u=(0,a.useMemo)((()=>a=>{if(void 0===n)return;const i=a(n),s={estimateMinutes:i.estimateMinutes-n.estimateMinutes,updatedEstimateMinutes:i.updatedEstimateMinutes-n.updatedEstimateMinutes,workMinutes:{}};for(const e in i.workMinutes){var c;s.workMinutes[e]=i.workMinutes[e]-(null!==(c=n.workMinutes[e])&&void 0!==c?c:0)}return t?(l("saving..."),(0,r.oc)(e).then((t=>{const n={estimateMinutes:t.estimateMinutes+s.estimateMinutes,updatedEstimateMinutes:t.updatedEstimateMinutes+s.updatedEstimateMinutes,workMinutes:{}};for(const e in s.workMinutes){var a;n.workMinutes[e]=(null!==(a=t.workMinutes[e])&&void 0!==a?a:0)+s.workMinutes[e]}return(0,r.Eo)(e,n)})).then((e=>(o(e),l("saved!"),setTimeout((()=>l("")),1e3),s))).catch((t=>{l(""),e.alert({display:"error",message:"error during save: ".concat(t)})}))):void 0}),[n,t]);return(0,a.useMemo)((()=>({value:n,set:u,feedback:i,refresh:c})),[n,i])}(e),n=(0,a.useState)(""),[c,d]=n,v=(0,i.Kb)(e,"id");if((0,y.cM)(e,t.refresh),void 0===t.value)return(0,f.jsx)("div",{children:t.feedback});const m=0!==t.value.updatedEstimateMinutes&&t.value.updatedEstimateMinutes!==t.value.estimateMinutes;return(0,f.jsxs)("div",{children:[(0,f.jsxs)("div",{className:"card-input-header",children:[(0,f.jsx)("input",{value:c,onChange:e=>d(e.target.value),placeholder:"input for all buttons..."}),(0,f.jsx)(l.b,{onEstimateChanged:t.refresh}),(0,f.jsxs)("div",{className:"top-right",children:[(0,f.jsx)(w,{}),(0,f.jsx)(p,{}),(0,f.jsx)(x,{onRefresh:t.refresh})]})]}),(0,f.jsx)(k,{label:(0,f.jsxs)(f.Fragment,{children:[m&&"Original ","Estimate: ",(0,o.JB)(t.value.estimateMinutes),m?[" | ","Updated: ",(0,o.JB)(t.value.updatedEstimateMinutes)]:null]}),action:(a,i)=>(0,o.MG)(e,n,(n=>{0!==t.value.estimateMinutes||m?e.popup({type:"confirm",title:"Update estimate?",message:"Do you want to update the estimate or change the original?",confirmText:"Update",onConfirm:e=>(t.set((e=>({...e,updatedEstimateMinutes:i((0,r.zR)(e),n)}))),e.closePopup()),cancelText:"Change original",onCancel:e=>(t.set((e=>({...e,estimateMinutes:i((0,r.zR)(e),n),updatedEstimateMinutes:0}))),e.closePopup()),mouseEvent:a.nativeEvent}):t.set((e=>({...e,estimateMinutes:i(e.estimateMinutes,n)})))})),clearAction:()=>t.set((e=>({...e,estimateMinutes:0,updatedEstimateMinutes:0})))}),void 0!==v?(0,f.jsx)(N,{estimate:t,member:v,inputState:n,className:"work"}):null,Boolean(t.feedback)?(0,f.jsx)("div",{children:t.feedback}):null]})}},9005:(e,t,n)=>{function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yyyy-MM-dd";return t.replaceAll("yyyy",e.getFullYear().toString()).replaceAll("MM",(e.getMonth()+1).toString().padStart(2,"0")).replaceAll("dd",e.getDate().toString().padStart(2,"0")).replaceAll("hh",e.getHours().toString().padStart(2,"0")).replaceAll("mm",e.getMinutes().toString().padStart(2,"0")).replaceAll("ss",e.getSeconds().toString().padStart(2,"0"))}n.d(t,{p:()=>a})},2168:(e,t,n)=>{n.d(t,{Q:()=>i,b:()=>r});var a=n(9005);const o="exit.datetime";function i(){window.addEventListener("pagehide",(e=>{localStorage.setItem(o,JSON.stringify(new Date))}));const e=r();console.log(o+": "+(e?(0,a.p)(e,"yyyy-MM-dd hh:mm:ss"):"null"))}function r(){const e=JSON.parse(localStorage.getItem(o));return e?new Date(e):null}},8282:(e,t,n)=>{n.d(t,{D3:()=>s,mY:()=>l});var a=n(4305),o=n(5728),i=n(9697);async function r(e,t){var n,r;const s=await(0,a.TO)(e),l=s[s.length-1];if(void 0===l||void 0!==l.endDate)return null===(n=t.action)||void 0===n?void 0:n.call(t);const c=(0,i.ne)(l.startDate);if(c<(0,o.fg)(2*t.hoursPerDay))return null===(r=t.action)||void 0===r?void 0:r.call(t);const u=(0,o.yz)((0,o.do)(c),{hoursPerDay:24});return new Promise(((n,o)=>{e.popup({type:"confirm",title:"Close old session?",message:"The current session looks old (".concat(u,"), do you want to close it and open a new one to save this work?"),confirmText:"Yes",onConfirm:async o=>{var i;l.endDate=new Date,await(0,a.qH)(e,s),n(null===(i=t.action)||void 0===i?void 0:i.call(t)),await o.closePopup()},cancelText:"No",onCancel:e=>{var a;return n(null===(a=t.action)||void 0===a?void 0:a.call(t)),e.closePopup()},mouseEvent:t.mouseEvent.nativeEvent})}))}function s(e,t){return r(e,{hoursPerDay:t.hoursPerDay,mouseEvent:t.mouseEvent,action:async()=>{var n;await(0,a.tm)(e,(async e=>e)),null===(n=t.action)||void 0===n||n.call(t)}})}function l(e,t){return r(e,{action:()=>(0,a.tm)(e,t.action),hoursPerDay:t.hoursPerDay,mouseEvent:t.mouseEvent})}}}]);
//# sourceMappingURL=914.acf2d822.chunk.js.map